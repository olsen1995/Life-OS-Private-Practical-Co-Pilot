name: Canon Audit Hook Coverage

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  audit-coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify audit hook coverage (excluding Canon read-only routes)
        run: |
          python - << 'EOF'
          import pathlib

          routes_dir = pathlib.Path("lifeos/routes")
          missing = []

          for f in routes_dir.rglob("*.py"):
              # Canon read-only routes are explicitly excluded
              if "canon" in f.name:
                  continue

              text = f.read_text(encoding="utf-8")
              if "audit_read(" not in text and "audit_read_with_provenance(" not in text:
                  missing.append(str(f))

          if missing:
              print("Missing audit hook in:")
              for m in missing:
                  print("-", m)
              raise SystemExit(1)

          print("Audit hook coverage OK (Canon routes excluded).")
          EOF

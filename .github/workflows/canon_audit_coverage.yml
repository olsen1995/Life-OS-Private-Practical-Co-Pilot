name: Canon Audit Hook Coverage

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  audit-coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify audit hook coverage (approved exclusions applied)
        run: |
          python - << 'EOF'
          import pathlib

          routes_dir = pathlib.Path("lifeos/routes")
          missing = []

          EXCLUDED_FILES = {
              "__init__.py",
              "healthz.py",
              "openapi_alias.py",
              "gpt_router.py",
              "memory_read_router.py",
              "mode_router.py",
              "metrics.py",
          }

          for f in routes_dir.rglob("*.py"):
              # Canon routes are read-only
              if "canon" in f.parts:
                  continue

              # Explicitly excluded system/meta routes
              if f.name in EXCLUDED_FILES:
                  continue

              text = f.read_text(encoding="utf-8")

              if (
                  "audit_read(" not in text
                  and "audit_read_with_provenance(" not in text
              ):
                  missing.append(str(f))

          if missing:
              print("Missing audit hook in the following routes:")
              for m in missing:
                  print("-", m)
              raise SystemExit(1)

          print("Audit hook coverage OK (approved exclusions applied).")
          EOF

name: LifeOS CI (Drift Guard + Upload Pack)

on:
  pull_request:
  push:
    branches: ["main"]

jobs:
  drift_guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read VERSION
        id: ver
        run: echo "version=$(cat VERSION | tr -d '\n')" >> $GITHUB_OUTPUT

      - name: Verify required files exist
        run: |
          set -e
          test -f instructions/Instructions.txt
          test -f canon/CANON_MANIFEST.json
          test -f knowledge/00_LifeOS_Constitution.md
          test -f knowledge/01_ModeRouter.md
          test -f knowledge/13_DecisionCheck.md

      - name: Drift guard â€” verify Instructions references resolve (best-effort)
        run: |
          set -e
          python3 - << 'PY'
          import re, os, sys

          path = "instructions/Instructions.txt"
          txt = open(path, "r", encoding="utf-8").read()

          # Find repo-like file references (simple heuristic):
          candidates = set(re.findall(r'\b(?:knowledge|canon|docs|instructions)/[A-Za-z0-9._\-/]+\b', txt))

          missing = []
          for c in sorted(candidates):
            if not os.path.exists(c):
              missing.append(c)

          if missing:
            print("Missing referenced paths from Instructions.txt:")
            for m in missing:
              print(f" - {m}")
            sys.exit(1)

          print(f"OK: {len(candidates)} referenced paths exist.")
          PY

      - name: Enforce version bump when instructions/knowledge changed (PR only)
        if: github.event_name == 'pull_request'
        run: |
          set -e
          base="${{ github.base_ref }}"
          git fetch origin "$base" --depth=50
          changed=$(git diff --name-only "origin/$base"...HEAD)

          echo "$changed" | grep -E '^(instructions/Instructions\.txt|knowledge/)' >/dev/null && changed_core=1 || changed_core=0
          echo "$changed" | grep -E '^VERSION$' >/dev/null && changed_version=1 || changed_version=0

          if [ "$changed_core" -eq 1 ] && [ "$changed_version" -eq 0 ]; then
            echo "ERROR: instructions/ or knowledge/ changed but VERSION was not bumped."
            exit 1
          fi

          echo "OK: Version discipline check passed."

  upload_pack:
    runs-on: ubuntu-latest
    needs: drift_guard
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read VERSION
        id: ver
        run: echo "version=$(cat VERSION | tr -d '\n')" >> $GITHUB_OUTPUT

      - name: Build Custom GPT Upload Pack
        run: |
          set -e
          mkdir -p dist/lifeos_upload_pack

          cp -f VERSION dist/lifeos_upload_pack/VERSION
          cp -f instructions/Instructions.txt dist/lifeos_upload_pack/instructions_Instructions.txt

          mkdir -p dist/lifeos_upload_pack/canon
          cp -f canon/CANON_MANIFEST.json dist/lifeos_upload_pack/canon/CANON_MANIFEST.json

          mkdir -p dist/lifeos_upload_pack/knowledge
          cp -f knowledge/00_LifeOS_Constitution.md dist/lifeos_upload_pack/knowledge/00_LifeOS_Constitution.md
          cp -f knowledge/01_ModeRouter.md dist/lifeos_upload_pack/knowledge/01_ModeRouter.md
          cp -f knowledge/13_DecisionCheck.md dist/lifeos_upload_pack/knowledge/13_DecisionCheck.md

          # Include docs that affect behavior (optional)
          mkdir -p dist/lifeos_upload_pack/docs/safety
          if [ -f docs/safety/TIER2_SAFETY_POLISH.md ]; then
            cp -f docs/safety/TIER2_SAFETY_POLISH.md dist/lifeos_upload_pack/docs/safety/TIER2_SAFETY_POLISH.md
          fi

          cd dist
          zip -r "LifeOS_CustomGPT_UploadPack_v${{ steps.ver.outputs.version }}.zip" lifeos_upload_pack

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: LifeOS_CustomGPT_UploadPack_v${{ steps.ver.outputs.version }}
          path: dist/LifeOS_CustomGPT_UploadPack_v${{ steps.ver.outputs.version }}.zip

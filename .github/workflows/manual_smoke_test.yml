name: Manual API Smoke Test

on:
  workflow_dispatch: {}

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          if [ -f "requirements.txt" ]; then
            python -m pip install -r requirements.txt
          elif [ -f "pyproject.toml" ]; then
            python -m pip install .
          else
            # Fallback minimal runtime deps for the smoke test
            python -m pip install fastapi uvicorn
          fi

      - name: Start API (background)
        shell: bash
        run: |
          set -e
          nohup python -m uvicorn lifeos.main:app --host 127.0.0.1 --port 8000 > uvicorn.log 2>&1 &
          echo $! > uvicorn.pid

          # Wait up to ~10 seconds for server to come up
          for i in {1..10}; do
            python -c "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/ask?message=ping&user_id=ping').read()" && break
            sleep 1
          done

      - name: Run smoke test
        shell: bash
        run: |
          python tools/smoke_test_api.py http://127.0.0.1:8000

      - name: Stop API + upload logs
        if: always()
        shell: bash
        run: |
          if [ -f uvicorn.pid ]; then
            kill $(cat uvicorn.pid) || true
          fi
          echo "---- uvicorn.log (tail) ----"
          tail -n 200 uvicorn.log || true
